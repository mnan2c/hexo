title: 堆、栈和方法区

tags:
  - JVM

categories:
  - JVM

---
## 1. 各司其职
- 堆内存用来存储Java中的对象。无论是成员变量，局部变量，还是类变量，它们指向的对象都存储在堆内存中，是线程共享的内存区域。
- 方法区用于存储已被虚拟机加载的类信息、常量、静态变量、即时编译器编译后的代码等数据，是线程共享的内存区域。
- 栈内存用来存储局部变量和方法调用，生命周期与线程相同，是线程私有的内存区域。
![](/img/java/xx-size.png)

### 1.1控制参数
1. JVM运行时堆的大小
  - -Xms堆的最小值
  - -Xmx堆空间的最大值
2. 新生代堆空间大小调整
  - -XX:NewSize新生代的最小值
  - -XX:MaxNewSize新生代的最大值
  - -XX:NewRatio设置新生代与老年代在堆空间的大小
  - -XX:SurvivorRatio新生代中Eden所占区域的大小
3. 永久代大小调整
  - -XX:MaxPermSize
4. 其他
  - -XX:MaxTenuringThreshold,设置将新生代对象转到老年代时需要经过多少次垃圾回收，但是仍然没有被回收

```java
// 设置JVM最大堆内存为3550M。
-Xmx3550m
// 设置JVM初始堆内存为3550M。
// 此值可以设置与-Xmx相同，以避免每次垃圾回收完成后JVM重新分配内存。
-Xms3550m
// 设置每个线程的栈大小。
// JDK5.0以后每个线程栈大小为1M，之前每个线程栈大小为256K。
// 应当根据应用的线程所需内存大小进行调整。
// 在相同物理内存下，减小这个值能生成更多的线程。
// 但是操作系统对一个进程内的线程数还是有限制的，不能无限生成，经验值在3000~5000左右。
// 需要注意的是：当这个值被设置的较大（例如>2MB）时将会在很大程度上降低系统的性能。
-Xss128k
// 设置年轻代大小为2G。
// 在整个堆内存大小确定的情况下，增大年轻代将会减小年老代，反之亦然。
// 此值关系到JVM垃圾回收，对系统性能影响较大，官方推荐配置为整个堆大小的3/8。
-Xmn2g
-XX:NewSize=1024m // 设置年轻代初始值为1024M。
-XX:MaxNewSize=1024m // 设置年轻代最大值为1024M。
-XX:PermSize=256m // 设置永久代初始值为256M。
-XX:MaxPermSize=256m // 设置永久代最大值为256M。
// 设置年轻代（包括1个Eden和2个Survivor区）与年老代的比值。
// 表示年轻代比年老代为1:4。
-XX:NewRatio=4
// 设置年轻代中Eden区与Survivor区的比值。
// 表示2个Survivor区（JVM堆内存年轻代中默认有2个大小相等的Survivor区）与1个Eden区的比值为2:4，
// 即1个Survivor区占整个年轻代大小的1/6。
-XX:SurvivorRatio=4
// 表示一个对象如果在Survivor区（救助空间）移动了7次还没有被垃圾回收就进入年老代。
// 如果设置为0的话，则年轻代对象不经过Survivor区，直接进入年老代，
// 对于需要大量常驻内存的应用，这样做可以提高效率。
// 如果将此值设置为一个较大值，则年轻代对象会在Survivor区进行多次复制，
// 这样可以增加对象在年轻代存活时间，增加对象在年轻代被垃圾回收的概率，
// 减少Full GC的频率，这样做可以在某种程度上提高服务稳定性。
-XX:MaxTenuringThreshold=7
```

没有直接设置老年代的参数，但是可以设置堆空间大小和新生代空间大小两个参数来间接控制: 老年代空间大小=堆空间大小-年轻代空间大小

## 2. 独有还是共享
- 栈内存归属于单个线程，每个线程都会有一个栈内存，其存储的变量只能在其所属线程中可见，即栈内存可以理解成线程的私有内存。
- 堆内存中的对象对所有线程可见。堆内存中的对象可以被所有线程访问。

## 3. 异常错误
- 如果栈内存没有可用的空间存储方法调用和局部变量，JVM会抛出java.lang.StackOverFlowError。
- 而如果是堆内存没有可用的空间存储生成的对象，JVM会抛出java.lang.OutOfMemoryError。

## 4. 空间大小
- 栈的内存要远远小于堆内存，如果你使用递归的话，那么你的栈很快就会充满。如果递归没有及时跳出，很可能发生StackOverFlowError问题。
- 可以通过-Xss选项设置栈内存的大小。-Xms选项可以设置堆的开始时的大小，-Xmx选项可以设置堆的最大值。
